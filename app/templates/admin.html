{% extends "base.html" %} {% block title %}Admin Dashboard - TechWomen Book
Club{% endblock %} {% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Admin Header -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
      <p class="text-gray-600">Manage the book club</p>
    </div>
    <a
      href="/dashboard"
      class="text-purple-600 hover:text-purple-800 font-medium"
    >
      ‚Üê Back to Member View
    </a>
  </div>

  <!-- Stats Cards -->
  <div class="grid md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-sm border p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">Total Members</p>
          <p class="text-3xl font-bold text-gray-900 mt-1">
            {{ total_members }}
          </p>
        </div>
        <div class="bg-purple-100 p-3 rounded-lg">
          <svg
            class="w-6 h-6 text-purple-600"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
            />
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">New This Month</p>
          <p class="text-3xl font-bold text-gray-900 mt-1">{{ new_members }}</p>
        </div>
        <div class="bg-green-100 p-3 rounded-lg">
          <svg
            class="w-6 h-6 text-green-600"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
            />
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">Pending Suggestions</p>
          <p class="text-3xl font-bold text-gray-900 mt-1">
            {{ pending_count }}
          </p>
        </div>
        <div class="bg-yellow-100 p-3 rounded-lg">
          <svg
            class="w-6 h-6 text-yellow-600"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
            <path
              fill-rule="evenodd"
              d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"
            />
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">Tracking Progress</p>
          <p class="text-3xl font-bold text-gray-900 mt-1">
            {{ engagement.tracking }}
          </p>
        </div>
        <div class="bg-blue-100 p-3 rounded-lg">
          <svg
            class="w-6 h-6 text-blue-600"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z"
            />
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Access Code Management -->
  <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 mb-4">
      üîë Access Code Management
    </h2>

    <div
      class="flex items-center justify-between bg-gray-50 p-4 rounded-lg mb-4"
    >
      <div>
        <p class="text-sm text-gray-600">Current Access Code</p>
        <p class="text-2xl font-bold text-purple-600 font-mono mt-1">
          {{ access_code.code if access_code else 'Not Set' }}
        </p>
        {% if access_code %}
        <p class="text-xs text-gray-500 mt-1">
          Last updated: {{ access_code.updated_at.strftime('%B %d, %Y') }}
        </p>
        {% endif %}
      </div>
      <button
        onclick="document.getElementById('code-modal').classList.remove('hidden')"
        class="bg-purple-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-purple-700"
      >
        Change Code
      </button>
    </div>

    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
      <p class="text-sm text-yellow-800">
        <strong>‚ö†Ô∏è Remember:</strong> After changing the code, post it in the
        WhatsApp group!
      </p>
    </div>
  </div>

  <!-- Current Book Management -->
  <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 mb-4">
      üìñ Current Book Management
    </h2>

    {% if current_book %}
    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-4">
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <h3 class="text-xl font-bold text-gray-900 mb-2">
            {{ current_book.title }}
          </h3>
          <p class="text-purple-600 mb-4">
            {{ current_book.current_chapters }}
          </p>
          <a
            href="{{ current_book.pdf_url }}"
            target="_blank"
            class="text-sm text-blue-600 hover:text-blue-800"
          >
            View PDF ‚Üí
          </a>
        </div>
        <button
          onclick="document.getElementById('edit-book-modal').classList.remove('hidden')"
          class="bg-white text-purple-600 border border-purple-600 px-4 py-2 rounded-lg font-medium hover:bg-purple-50 mr-2"
        >
          Edit Details
        </button>
        <button
          onclick="document.getElementById('complete-modal').classList.remove('hidden')"
          class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700"
        >
          Mark Completed
        </button>
      </div>
    </div>
    {% else %}
    <div
      class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center"
    >
      <p class="text-gray-600 mb-4">No current book set</p>
      <p class="text-sm text-gray-500">
        Select a book from the approved queue below
      </p>
    </div>
    {% endif %}
  </div>

  <!-- Meeting Management -->
  <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 mb-4">üìÖ Meeting Management</h2>

    {% if meeting %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="font-semibold text-gray-900">
            {{ meeting.date }} at {{ meeting.time }}
          </p>
          <a
            href="{{ meeting.meet_link }}"
            target="_blank"
            class="text-sm text-blue-600 hover:text-blue-800"
          >
            {{ meeting.meet_link }}
          </a>
        </div>
        <button
          onclick="document.getElementById('meeting-modal').classList.remove('hidden')"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700"
        >
          Edit Meeting
        </button>
      </div>
    </div>
    {% else %}
    <button
      onclick="document.getElementById('meeting-modal').classList.remove('hidden')"
      class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700"
    >
      Set Meeting Details
    </button>
    {% endif %}
  </div>

  <!-- Pending Suggestions -->
  <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 mb-4">
      üí° Pending Book Suggestions ({{ pending_count }})
    </h2>

    {% if pending_suggestions %}
    <div class="space-y-4">
      {% for suggestion in pending_suggestions %}
      <div class="border border-gray-200 rounded-lg p-4">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h4 class="font-semibold text-gray-900 mb-1">
              {{ suggestion.title }}
            </h4>
            <p class="text-sm text-gray-600 mb-2">
              Suggested by: <strong>{{ suggestion.user_name }}</strong> ({{
              suggestion.user_email }})
            </p>
            <a
              href="{{ suggestion.pdf_url }}"
              target="_blank"
              class="text-sm text-blue-600 hover:text-blue-800"
            >
              üìÑ View PDF ‚Üí
            </a>
          </div>
          <div class="flex space-x-2">
            <button
              hx-put="/api/admin/suggestions/{{ suggestion.id }}/approve"
              hx-confirm="Approve '{{ suggestion.title }}'?"
              hx-target="closest div.border"
              hx-swap="outerHTML"
              class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700"
            >
              ‚úì Approve
            </button>
            <button
              hx-put="/api/admin/suggestions/{{ suggestion.id }}/reject"
              hx-confirm="Reject '{{ suggestion.title }}'?"
              hx-target="closest div.border"
              hx-swap="outerHTML"
              class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700"
            >
              ‚úó Reject
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div
      class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"
    >
      <p class="text-gray-500">No pending suggestions</p>
    </div>
    {% endif %}
  </div>

  <!-- Approved Queue -->
  <div class="bg-white rounded-xl shadow-sm border p-6">
    <h2 class="text-xl font-bold text-gray-900 mb-4">
      üìö Approved Books Queue
    </h2>

    {% if approved_queue %}
    <div class="space-y-3">
      {% for book in approved_queue %}
      <div
        class="flex items-center justify-between border border-gray-200 rounded-lg p-4"
      >
        <div class="flex-1">
          <h4 class="font-semibold text-gray-900">{{ book.title }}</h4>
          <a
            href="{{ book.pdf_url }}"
            target="_blank"
            class="text-sm text-blue-600 hover:text-blue-800"
          >
            View PDF ‚Üí
          </a>
        </div>
        {% if not current_book %}
        <button
          type="button"
          onclick="openSetCurrentModal({{ book.id }}, `{{ book.title }}`)"
          class="bg-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-700"
        >
          Set as Current
        </button>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div
      class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"
    >
      <p class="text-gray-500">No approved books in queue</p>
    </div>
    {% endif %}
  </div>
  <!-- Admin Activity Logs -->
  <div class="bg-white rounded-xl shadow-sm border p-6 mt-8">
    <h2 class="text-xl font-bold text-gray-900 mb-4">
      üìã Recent Admin Activity
    </h2>

    {% if admin_logs %}
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Admin
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Action
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Details
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Time
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for log in admin_logs %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div
                  class="flex-shrink-0 h-8 w-8 bg-purple-100 rounded-full flex items-center justify-center"
                >
                  <span class="text-purple-600 font-semibold text-sm">
                    {{ log.admin_name[0].upper() }}
                  </span>
                </div>
                <div class="ml-3">
                  <div class="text-sm font-medium text-gray-900">
                    {{ log.admin_name }}
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-gray-900">
                {% if log.action == "approve_suggestion" %}
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                >
                  ‚úì Approved Suggestion
                </span>
                {% elif log.action == "reject_suggestion" %}
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"
                >
                  ‚úó Rejected Suggestion
                </span>
                {% elif log.action == "update_access_code" %}
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800"
                >
                  üîë Updated Access Code
                </span>
                {% elif log.action == "set_current_book" %}
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                >
                  üìñ Set Current Book
                </span>
                {% elif log.action == "update_current_book" %}
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                >
                  ‚úèÔ∏è Updated Book
                </span>
                {% elif log.action == "complete_book" %}
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                >
                  ‚úîÔ∏è Completed Book
                </span>
                {% elif log.action == "update_meeting" %}
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"
                >
                  üìÖ Updated Meeting
                </span>
                {% else %}
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
                >
                  {{ log.action }}
                </span>
                {% endif %}
              </div>
            </td>
            <td class="px-6 py-4">
              <div
                class="text-sm text-gray-500 max-w-xs truncate"
                title="{{ log.target }}"
              >
                {{ log.target or 'N/A' }}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {{ log.timestamp.strftime('%b %d, %Y at %I:%M %p') }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div
      class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"
    >
      <p class="text-gray-500">No admin activity recorded yet</p>
    </div>
    {% endif %}
  </div>
  <!-- User Management -->
  <div class="bg-white rounded-xl shadow-sm border p-6 mt-8">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold text-gray-900">üë• User Management</h2>
      <span class="text-sm text-gray-600">
        Total: {{ total_members }} | Admins: {{ admin_count }}
      </span>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              User
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Role
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Joined
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for user in all_users %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div
                  class="flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center {% if user.is_admin %}bg-purple-100{% else %}bg-blue-100{% endif %}"
                >
                  <span
                    class="font-medium text-sm {% if user.is_admin %}text-purple-600{% else %}text-blue-600{% endif %}"
                  >
                    {{ user.name[0].upper() }}
                  </span>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">
                    {{ user.name }} {% if user.id == admin.id %}
                    <span class="text-purple-600">(You)</span>
                    {% endif %}
                  </div>
                  <div class="text-sm text-gray-500">{{ user.email }}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if user.is_admin %}
              <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800"
              >
                ‚≠ê Admin
              </span>
              {% else %}
              <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
              >
                üë§ Member
              </span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {{ user.created_at.strftime('%b %d, %Y') }}
            </td>
            <!-- Find this section in your admin.html -->
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              {% if user.id != admin.id %} {% if user.is_admin %}
              <!-- Demote button -->
              <button
                onclick="demoteUser({{ user.id }}, '{{ user.name }}')"
                class="text-orange-600 hover:text-orange-800 font-medium"
                {%
                if
                admin_count|int
                <=1
                %}disabled
                title="Cannot demote last admin"
                {%
                endif
                %}
              >
                ‚Üì Demote
              </button>
              {% else %}
              <!-- Promote button -->
              <button
                onclick="promoteUser({{ user.id }}, '{{ user.name }}')"
                class="text-green-600 hover:text-green-800 font-medium"
              >
                ‚Üë Promote
              </button>
              {% endif %} {% else %}
              <span class="text-gray-400">‚Äî</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
      <p class="text-sm text-blue-800">
        <strong>‚ÑπÔ∏è Admin Management Guidelines:</strong>
      </p>
      <ul class="text-sm text-blue-700 mt-2 ml-4 list-disc space-y-1">
        <li>Admins can manage books, meetings, and approve suggestions</li>
        <li>You cannot demote yourself - ask another admin</li>
        <li>There must always be at least one admin</li>
        <li>All admin changes are logged for transparency</li>
      </ul>
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Change Code Modal -->
<div
  id="code-modal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
>
  <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
    <h3 class="text-xl font-bold mb-4">Change Access Code</h3>
    <form hx-put="/api/admin/code" hx-target="#code-result">
      <input
        type="text"
        name="new_code"
        placeholder="Enter new code"
        class="w-full px-4 py-2 border rounded-lg mb-4"
        required
      />
      <div id="code-result" class="mb-4"></div>
      <div class="flex space-x-2">
        <button
          type="submit"
          class="flex-1 bg-purple-600 text-white py-2 rounded-lg"
        >
          Update
        </button>
        <button
          type="button"
          onclick="document.getElementById('code-modal').classList.add('hidden')"
          class="flex-1 bg-gray-300 py-2 rounded-lg"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Book Modal -->
<div
  id="edit-book-modal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
>
  <div
    class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto"
  >
    <h3 class="text-xl font-bold mb-4">Edit Current Book</h3>
    <form
      hx-put="/api/admin/books/current"
      hx-target="#edit-result"
      class="space-y-4"
    >
      <div>
        <label class="block text-sm font-medium mb-2">Title</label>
        <input
          type="text"
          name="title"
          value="{{ current_book.title if current_book else '' }}"
          class="w-full px-4 py-2 border rounded-lg"
        />
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">Cover Image URL</label>
        <input
          type="url"
          name="cover_image_url"
          value="{{ current_book.cover_image_url if current_book else '' }}"
          placeholder="https://example.com/cover.jpg"
          class="w-full px-4 py-2 border rounded-lg"
        />
        <p class="text-xs text-gray-500 mt-1">
          Optional: Direct link to book cover image
        </p>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">PDF URL</label>
        <input
          type="url"
          name="pdf_url"
          value="{{ current_book.pdf_url if current_book else '' }}"
          class="w-full px-4 py-2 border rounded-lg"
        />
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">Current Chapters</label>
        <input
          type="text"
          name="current_chapters"
          value="{{ current_book.current_chapters if current_book else '' }}"
          placeholder="e.g., Chapters 3-4"
          class="w-full px-4 py-2 border rounded-lg"
        />
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">Total Chapters</label>
        <input
          type="number"
          name="total_chapters"
          value="{{ current_book.total_chapters if current_book else '' }}"
          class="w-full px-4 py-2 border rounded-lg"
        />
      </div>
      <div id="edit-result"></div>
      <div class="flex space-x-2">
        <button
          type="submit"
          class="flex-1 bg-purple-600 text-white py-2 rounded-lg"
        >
          Save Changes
        </button>
        <button
          type="button"
          onclick="document.getElementById('edit-book-modal').classList.add('hidden')"
          class="flex-1 bg-gray-300 py-2 rounded-lg"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Meeting Modal -->
<div
  id="meeting-modal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
>
  <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
    <h3 class="text-xl font-bold mb-4">Meeting Details</h3>
    <form
      hx-put="/api/admin/meeting"
      hx-target="#meeting-result"
      class="space-y-4"
    >
      <div>
        <label class="block text-sm font-medium mb-2">Date</label>
        <input
          type="text"
          name="date"
          value="{{ meeting.date if meeting else '' }}"
          placeholder="December 15, 2024"
          class="w-full px-4 py-2 border rounded-lg"
          required
        />
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">Time</label>
        <input
          type="text"
          name="time"
          value="{{ meeting.time if meeting else '' }}"
          placeholder="7:00 PM EAT"
          class="w-full px-4 py-2 border rounded-lg"
          required
        />
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">Google Meet Link</label>
        <input
          type="url"
          name="meet_link"
          value="{{ meeting.meet_link if meeting else '' }}"
          placeholder="https://meet.google.com/..."
          class="w-full px-4 py-2 border rounded-lg"
          required
        />
      </div>
      <div id="meeting-result"></div>
      <div class="flex space-x-2">
        <button
          type="submit"
          class="flex-1 bg-blue-600 text-white py-2 rounded-lg"
        >
          Save
        </button>
        <button
          type="button"
          onclick="document.getElementById('meeting-modal').classList.add('hidden')"
          class="flex-1 bg-gray-300 py-2 rounded-lg"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Complete Book Modal -->
<div
  id="complete-modal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
>
  <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
    <h3 class="text-xl font-bold mb-4">Mark Book as Completed?</h3>
    <p class="text-gray-600 mb-6">
      This will move "{{ current_book.title if current_book else '' }}" to past
      books.
    </p>
    <div class="flex space-x-2">
      <button
        hx-post="/api/admin/books/complete"
        hx-target="#complete-result"
        class="flex-1 bg-green-600 text-white py-2 rounded-lg"
      >
        Yes, Complete
      </button>
      <button
        onclick="document.getElementById('complete-modal').classList.add('hidden')"
        class="flex-1 bg-gray-300 py-2 rounded-lg"
      >
        Cancel
      </button>
    </div>
    <div id="complete-result" class="mt-4"></div>
  </div>
</div>
<!-- Set Current Book Modal -->
<div
  id="set-current-modal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
>
  <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
    <h3 class="text-xl font-bold mb-4">Set Book as Current</h3>
    <p class="text-sm text-gray-600 mb-4" id="set-current-title">
      Set this book as the current read.
    </p>

    <form
      id="set-current-form"
      onsubmit="return onSetCurrentSubmit(event)"
      class="space-y-4"
    >
      <div>
        <label class="block text-sm font-medium mb-2"> Current Chapters </label>
        <input
          type="text"
          name="current_chapters"
          placeholder="e.g., Chapters 3‚Äì4"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
          required
        />
        <p class="text-xs text-gray-500 mt-1">
          This will be shown on the member dashboard.
        </p>
      </div>

      <div>
        <label class="block text-sm font-medium mb-2">
          Cover Image URL (optional)
        </label>
        <input
          type="url"
          name="cover_image_url"
          placeholder="https://example.com/cover.jpg"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
        />
      </div>

      <div id="set-current-result" class="text-sm text-gray-600"></div>

      <div class="flex space-x-2">
        <button
          type="submit"
          class="flex-1 bg-purple-600 text-white py-2 rounded-lg font-medium hover:bg-purple-700"
        >
          Set as Current
        </button>
        <button
          type="button"
          onclick="closeSetCurrentModal()"
          class="flex-1 bg-gray-300 py-2 rounded-lg font-medium hover:bg-gray-400"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function approveSuggestion(suggestionId, title) {
    const coverUrl = prompt(
      `Add cover image URL for "${title}" (optional):`,
      ""
    );

    fetch(`/api/admin/suggestions/${suggestionId}/approve`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        cover_image_url: coverUrl || null,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        showToast(data.message, "success");
        setTimeout(() => location.reload(), 1000);
      })
      .catch((error) => {
        showToast("Error: " + error.message, "error");
      });
  }

  // Fix for setCurrentBook function that uses fetch
  // Set Current Book Modal helpers
  let currentBookIdForModal = null;

  function openSetCurrentModal(bookId, title) {
    currentBookIdForModal = bookId;

    const modal = document.getElementById("set-current-modal");
    const titleEl = document.getElementById("set-current-title");
    const form = document.getElementById("set-current-form");

    if (titleEl) {
      titleEl.textContent = `Set "${title}" as the current book.`;
    }

    // Reset form
    form.reset();

    modal.classList.remove("hidden");
  }

  function closeSetCurrentModal() {
    const modal = document.getElementById("set-current-modal");
    modal.classList.add("hidden");
  }

  function onSetCurrentSubmit(event) {
    event.preventDefault(); // Prevent form submission

    const form = document.getElementById("set-current-form");
    const currentChapters = form.querySelector(
      '[name="current_chapters"]'
    ).value;
    const coverImageUrl = form.querySelector('[name="cover_image_url"]').value;

    if (!currentChapters) {
      showToast("Current chapters are required", "error");
      return false;
    }

    // Use fetch() like the original code
    fetch(`/api/admin/books/${currentBookIdForModal}/set-current`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        current_chapters: currentChapters,
        cover_image_url: coverImageUrl || null,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        showToast(data.message, data.success ? "success" : "error");
        if (data.success) {
          setTimeout(() => {
            closeSetCurrentModal();
            window.location.reload();
          }, 1000);
        }
      })
      .catch((error) => {
        showToast("Error: " + error.message, "error");
      });

    return false;
  }

  // Keep the other HTMX listeners for other modals
  // Handle HTMX responses
  document.addEventListener("htmx:afterSwap", function (event) {
    const targetId = event.detail.target.id;
    if (
      [
        "code-result",
        "edit-result",
        "meeting-result",
        "complete-result",
      ].includes(targetId)
    ) {
      showToast("Changes saved successfully!", "success");
      setTimeout(() => location.reload(), 1500);
    }
  });

  function promoteUser(userId, userName) {
    if (
      confirm(
        `Promote ${userName} to admin?\n\nThey will be able to:\n‚Ä¢ Manage books and meetings\n‚Ä¢ Approve/reject suggestions\n‚Ä¢ Access admin panel`
      )
    ) {
      fetch(`/api/admin/users/${userId}/promote`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
      })
        .then((response) => response.json())
        .then((data) => {
          showToast(data.message, data.success ? "success" : "error");
          if (data.success) {
            setTimeout(() => location.reload(), 1500);
          }
        })
        .catch((error) => {
          showToast("Error: " + error.message, "error");
        });
    }
  }

  function demoteUser(userId, userName) {
    if (
      confirm(
        `Demote ${userName} from admin?\n\nThey will lose access to:\n‚Ä¢ Admin panel\n‚Ä¢ Book/meeting management\n‚Ä¢ Suggestion approval`
      )
    ) {
      fetch(`/api/admin/users/${userId}/demote`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
      })
        .then((response) => response.json())
        .then((data) => {
          showToast(data.message, data.success ? "success" : "error");
          if (data.success) {
            setTimeout(() => location.reload(), 1500);
          }
        })
        .catch((error) => {
          showToast("Error: " + error.message, "error");
        });
    }
  }
</script>
{% endblock %}
