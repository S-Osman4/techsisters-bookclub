{% extends "base.html" %}

{% block title %}Dashboard - TechWomen Book Club{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Guest Banner (if not logged in) -->
    {% if is_guest %}
    <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-l-4 border-purple-500 p-6 rounded-lg mb-8 shadow-sm">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">
                    üëã Browsing as Guest
                </h3>
                <p class="text-gray-700">
                    Create an account to suggest books, track your progress, and unlock more features!
                </p>
            </div>
            <a href="/register" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold whitespace-nowrap ml-4">
                Create Account
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- Current Book Section -->
    <div class="mb-8">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">üìñ Currently Reading</h2>
    
    {% if current_book %}
    <div class="bg-white rounded-xl shadow-sm border p-6 card-hover featured-book">
        <div class="flex flex-col md:flex-row gap-6">
        
        <!-- Book Cover -->
        <div class="flex-shrink-0">
            {% if current_book.cover_image_url %}
            <img 
                src="{{ current_book.cover_image_url }}" 
                alt="{{ current_book.title }}" 
                class="w-40 h-56 object-cover rounded-lg shadow-lg"
                onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22160%22 height=%22224%22%3E%3Crect width=%22160%22 height=%22224%22 fill=%22%23667eea%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2240%22 fill=%22white%22%3Eüìö%3C/text%3E%3C/svg%3E';"
            >
            {% else %}
            <!-- Fallback gradient placeholder -->
            <div class="w-40 h-56 bg-gradient-to-br from-purple-400 via-pink-400 to-purple-600 rounded-lg shadow-lg flex items-center justify-center">
                <span class="text-white text-5xl">üìö</span>
            </div>
            {% endif %}
        </div>
        
        <!-- Book Details -->
        <div class="flex-1">
            <h3 class="text-2xl font-bold text-gray-900 mb-2">{{ current_book.title }}</h3>
            <p class="text-purple-600 font-medium mb-4">{{ current_book.current_chapters }}</p>
            
            {% if meeting %}
            <div class="space-y-2 text-gray-600 mb-4">
            <p class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                </svg>
                <strong>Next Meeting:</strong>&nbsp;{{ meeting.date }} at {{ meeting.time }}
            </p>
            <a href="{{ meeting.meet_link }}" target="_blank" 
                class="inline-flex items-center text-blue-600 hover:text-blue-800">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/>
                <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/>
                </svg>
                Join Google Meet
            </a>
            </div>
            {% endif %}
            
            <a href="{{ current_book.pdf_url }}" target="_blank" 
            class="btn-primary text-white px-6 py-3 rounded-lg font-semibold inline-block">
            üì• Download PDF
            </a>
        </div>
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üìö</div>
        <p class="text-gray-500">No book currently selected. Check back soon!</p>
    </div>
    {% endif %}
    </div>
    
    <!-- Progress Section -->
    {% if current_book %}
    <div class="grid md:grid-cols-2 gap-8 mb-8">
        <!-- Your Progress -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Your Progress</h3>

            {% if current_user %}
                <!-- Existing member form stays the same -->
                <form
                    hx-put="/api/books/progress"
                    hx-target="#progress-result"
                    hx-swap="innerHTML"
                    class="space-y-4"
                >
                    <input type="hidden" name="book_id" value="{{ current_book.id }}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Current Chapter
                        </label>
                        <select
                            name="chapter"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                        >
                            <option value="0"
                                {% if not user_progress or user_progress.chapter == 0 %}selected{% endif %}
                            >
                                Not Started
                            </option>

                            {% if current_book.total_chapters %}
                                {% for i in range(1, current_book.total_chapters + 1) %}
                                    <option value="{{ i }}"
                                        {% if user_progress and user_progress.chapter == i %}selected{% endif %}
                                    >
                                        Chapter {{ i }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                {% for i in range(1, 11) %}
                                    <option value="{{ i }}"
                                        {% if user_progress and user_progress.chapter == i %}selected{% endif %}
                                    >
                                        Chapter {{ i }}
                                    </option>
                                {% endfor %}
                            {% endif %}

                            <option value="-1"
                                {% if user_progress and user_progress.chapter == -1 %}selected{% endif %}
                            >
                                Completed
                            </option>
                        </select>
                    </div>

                    <div id="progress-result"></div>

                    <button
                        type="submit"
                        class="w-full bg-purple-600 text-white py-2 rounded-lg font-medium hover:bg-purple-700"
                    >
                        Update Progress
                    </button>
                </form>
            {% else %}
                <!-- Guest locked state -->
                <p class="text-gray-600 mb-4">
                    Create an account to track your reading for this book.
                </p>
                <a
                    href="/register"
                    class="inline-flex items-center justify-center w-full bg-purple-600 text-white py-2 rounded-lg font-medium hover:bg-purple-700"
                >
                    Create Account to Track Progress
                </a>
            {% endif %}
        </div>

        <!-- Community Progress -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Community Progress</h3>

            {% if community_stats %}
                <div class="space-y-3">
                    {% for stat in community_stats %}
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-medium text-gray-700">{{ stat.range }}</span>
                                <span class="text-gray-600">
                                    {{ stat.count }} members ¬∑ {{ stat.percentage }}%
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div
                                    class="bg-purple-600 h-2 rounded-full"
                                    style="width: {{ stat.percentage }}%;"
                                ></div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 text-center py-4">
                    No progress data yet. Be the first to update your chapter.
                </p>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Book Suggestion Form -->
    <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Suggest a Book</h3>

        {% if current_user %}
            <form hx-post="/api/books/suggestions" 
                hx-target="#suggestion-result"
                hx-swap="innerHTML"
                class="space-y-4">
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Book Title
                        </label>
                        <input type="text" 
                            name="title" 
                            placeholder="e.g., Atomic Habits"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            PDF URL
                        </label>
                        <input type="url" 
                            name="pdf_url" 
                            placeholder="https://example.com/book.pdf"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            required>
                    </div>
                </div>
                
                <div id="suggestion-result"></div>
                
                <button type="submit" 
                        class="bg-purple-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-purple-700">
                    Submit Suggestion
                </button>
            </form>
        {% else %}
            <p class="text-gray-600 mb-4">
                Only members can suggest books for the club.
            </p>
            <div class="flex flex-col sm:flex-row gap-3">
                <a
                    href="/register"
                    class="flex-1 bg-purple-600 text-white px-6 py-2 rounded-lg font-medium text-center hover:bg-purple-700"
                >
                    Create Account
                </a>
                <a
                    href="/login"
                    class="flex-1 border border-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium text-center hover:bg-gray-50"
                >
                    Login
                </a>
            </div>
        {% endif %}
    </div>

    {% if current_user and user_suggestions %}
        <!-- Your Suggestions -->
        <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-900 mb-4">üìù Your Suggestions</h3>
            
            <div class="space-y-3">
                {% for suggestion in user_suggestions %}
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-900">{{ suggestion.title }}</h4>
                        <a href="{{ suggestion.pdf_url }}" target="_blank" class="text-sm text-blue-600 hover:text-blue-800">
                            View PDF ‚Üí
                        </a>
                    </div>
                    <div>
                        {% if suggestion.status == 'pending' %}
                            <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                                ‚è≥ Pending
                            </span>
                        {% elif suggestion.status == 'approved' %}
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                                ‚úì Approved
                            </span>
                        {% else %}
                            <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">
                                ‚úó Rejected
                            </span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    
    <!-- Upcoming Books -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">üìö Upcoming Books</h2>
        
        {% if upcoming_books %}
        <div class="grid md:grid-cols-3 gap-4">
            {% for book in upcoming_books %}
            <div class="bg-white rounded-lg shadow-sm border p-4 card-hover">
                <h4 class="font-semibold text-gray-900 mb-2">{{ book.title }}</h4>
                <p class="text-sm text-gray-600">In queue</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
            <p class="text-gray-500">No upcoming books yet.</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Past Books -->
    <div>
    <h2 class="text-2xl font-bold text-gray-900 mb-4">üìñ Past Books</h2>
    
    {% if past_books %}
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for book in past_books %}
        <div class="bg-white rounded-lg shadow-sm border p-4 card-hover">
        <div class="flex gap-4">
            <!-- Book Cover Thumbnail -->
            <div class="flex-shrink-0">
            {% if book.cover_image_url %}
                <img 
                src="{{ book.cover_image_url }}" 
                alt="{{ book.title }}" 
                class="w-16 h-24 object-cover rounded shadow-sm"
                onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'w-16 h-24 bg-gradient-to-br from-purple-400 to-pink-400 rounded shadow-sm flex items-center justify-center\'><span class=\'text-white text-xl\'>üìö</span></div>';"
                >
            {% else %}
                <div class="w-16 h-24 bg-gradient-to-br from-purple-400 to-pink-400 rounded shadow-sm flex items-center justify-center">
                <span class="text-white text-xl">üìö</span>
                </div>
            {% endif %}
            </div>
            
            <!-- Book Info -->
            <div class="flex-1">
            <h4 class="font-semibold text-gray-900 mb-2">{{ book.title }}</h4>
            <p class="text-sm text-gray-600 mb-3">
                Completed: {{ book.completed_date.strftime('%B %Y') if book.completed_date else 'N/A' }}
            </p>
            <a href="{{ book.pdf_url }}" target="_blank" 
                class="text-sm text-purple-600 hover:text-purple-800 font-medium">
                üì• Download PDF
            </a>
            </div>
        </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üìñ</div>
        <p class="text-gray-500">No past books yet.</p>
    </div>
    {% endif %}
    </div>
</div>

<script>
    // Handle progress update
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'progress-result') {
            showToast('Progress updated successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        }
        
        if (event.detail.target.id === 'suggestion-result') {
            showToast('Book suggestion submitted!', 'success');
            setTimeout(() => location.reload(), 1500);
        }
    });
</script>
{% endblock %}